<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <meta charset="utf-8"/>
    <title>文曲星模拟器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/BrowserFS/2.0.0/browserfs.min.js"></script>
    <script src="src/m65c02.js"></script>
    <!--<script src="refs/wqxsimlogs.js"></script>-->
    <script src="src/wqx.js"></script>
    <script src="src/keyinput.js"></script>
    <style>
        #wqx {
            width: 370px;
        }
        #lcd {
            width: 320px;
            height: 160px;
            background-color: #98fb98;
            padding-right: 50px;
	    position: absolute;
	    left: 26px;
    	    top: 122px;
        }
      
    </style>
</head>
<body>
<h1>文曲星模拟器</h1>
<button id="run" onclick="run();" disabled>run</button>
<button id="stop" onclick="stop();" disabled>stop</button>
<button id="reset" onclick="reset();">reset</button>
<button id="load_demo">loadDemo</button>
<div id="wqx">
    <div id="lcd"></div>     
</div>
 <canvas id="key" tabindex="0" width="434" height="543" style = "height = 543; width = 434;"></canvas>
<p>
    <span>orginal: <a href="http://bbs.emsky.net/viewthread.php?tid=33474">http://bbs.emsky.net/viewthread.php?tid=33474</a><br/>
        目前只在chrome浏览器测试过，别的浏览器应该也有能跑的。<br/>
        由于ROM文件有24M之大，若加载过慢，请自行下载到硬盘上，拖拽到模拟器的屏幕区域手动加载。<br/>
        若想要离线使用能正常加载，请在chrome启动参数中加入`--allow-file-access-from-files`。<br/>
        2018.09.11 Dr.Quest优化版，压缩ROM到10M ZIP文件，添加了手机触摸屏支持<br/>
	2023.12.24 leoncoolmoon 修改了图形UI <a href="https://github.com/leoncoolmoon/jswqx1020">github</a> <br/>

        <a href="rom.zip">ROM文件下载地址</a></span>
</p>
<script>
   // Array of keys
    var keys = [
 { name: 'F1', x: 403 ,y: 20 , width: 28, height: 15},  
 { name: 'F2', x: 403 ,y: 55 , width: 28, height: 15},  
 { name: 'F3', x: 403 ,y: 90 , width: 28, height: 15},  
 { name: 'F4', x: 403 ,y: 125 , width: 28, height: 15},  
 { name: 'F12', x: 400 ,y: 190 , width: 32, height: 32}, 
 
// { name: 'F1', x: 2 ,y: 380 , width: 43, height: 32},  
// { name: 'F1', x: 45 ,y: 380 , width: 43, height: 32},  
 { name: 'Reset', x: 105 ,y: 390 , width: 10, height: 10},  
 { name: 'F8', x: 131 ,y: 380 , width: 43, height: 32},  
 { name: 'F9', x: 174 ,y: 380 , width: 43, height: 32},  
 { name: 'F10', x: 217 ,y: 380 , width: 43, height: 32},  
 { name: 'F7', x: 260 ,y: 380 , width: 43, height: 32},  
 { name: 'F6', x: 303 ,y: 380 , width: 43, height: 32},  
 { name: 'F5', x: 346 ,y: 380 , width: 43, height: 32},  
 { name: 'F11', x: 389 ,y: 380 , width: 43, height: 32},  
      
 { name: 'Q', x: 2 ,y: 412 , width: 43, height: 32},  
 { name: 'W', x: 45 ,y: 412 , width: 43, height: 32},  
 { name: 'E', x: 88 ,y: 412 , width: 43, height: 32},  
 { name: 'R', x: 131 ,y: 412 , width: 43, height: 32},  
 { name: 'T', x: 174 ,y: 412 , width: 43, height: 32},  
 { name: 'Y', x: 217 ,y: 412 , width: 43, height: 32},  
 { name: 'U', x: 260 ,y: 412 , width: 43, height: 32},  
 { name: 'I', x: 303 ,y: 412 , width: 43, height: 32},  
 { name: 'O', x: 346 ,y: 412 , width: 43, height: 32},  
 { name: 'P', x: 389 ,y: 412 , width: 43, height: 32},  
      
 { name: 'A', x: 2 ,y: 444 , width: 43, height: 32},  
 { name: 'S', x: 45 ,y: 444 , width: 43, height: 32},  
 { name: 'D', x: 88 ,y: 444 , width: 43, height: 32},  
 { name: 'F', x: 131 ,y: 444 , width: 43, height: 32},  
 { name: 'G', x: 174 ,y: 444 , width: 43, height: 32},  
 { name: 'H', x: 217 ,y: 444 , width: 43, height: 32},  
 { name: 'J', x: 260 ,y: 444 , width: 43, height: 32},  
 { name: 'K', x: 303 ,y: 444 , width: 43, height: 32},  
 { name: 'L', x: 346 ,y: 444 , width: 43, height: 32},  
 { name: 'Enter', x: 389 ,y: 444 , width: 43, height: 32},  
      
 { name: 'Z', x: 2 ,y: 476 , width: 43, height: 32},  
 { name: 'X', x: 45 ,y: 476 , width: 43, height: 32},  
 { name: 'C', x: 88 ,y: 476 , width: 43, height: 32},  
 { name: 'V', x: 131 ,y: 476 , width: 43, height: 32},  
 { name: 'B', x: 174 ,y: 476 , width: 43, height: 32},  
 { name: 'N', x: 217 ,y: 476 , width: 43, height: 32},  
 { name: 'M', x: 260 ,y: 476 , width: 43, height: 32},  
 { name: 'PgUp', x: 303 ,y: 476 , width: 43, height: 32},  
 { name: 'Up', x: 346 ,y: 476 , width: 43, height: 32},  
 { name: 'PgDn', x: 389 ,y: 476 , width: 43, height: 32},  
      
 { name: 'Tab', x: 2 ,y: 508 , width: 43, height: 32},  
 { name: 'Shift', x: 45 ,y: 508 , width: 43, height: 32},  
 { name: 'CapsLock', x: 88 ,y: 508 , width: 43, height: 32},  
 { name: 'Esc', x: 131 ,y: 508 , width: 43, height: 32},  
 { name: '0', x: 174 ,y: 508 , width: 43, height: 32},  
 { name: 'Period', x: 217 ,y: 508 , width: 43, height: 32},  
 { name: 'Equals', x: 260 ,y: 508 , width: 43, height: 32},  
 { name: 'Left', x: 303 ,y: 508 , width: 43, height: 32},  
 { name: 'Down', x: 346 ,y: 508 , width: 43, height: 32},  
 { name: 'Right', x: 389 ,y: 508 , width: 43, height: 32}, 
 ];
   // Get the canvas element
    var canvas = document.getElementById('key');

    // Get the context of the canvas
    var ctx = canvas.getContext('2d');

    // Load the image
    var image = new Image();
    image.onload = function() {
      // Draw the image to the canvas
      ctx.drawImage(image, 0, 0);
    };
    image.src = 'nc1020.png';

 // Add event listeners to the canvas
      canvas.addEventListener('mousedown', function(e) {
        // Get the coordinates of the click
		var rect = canvas.getBoundingClientRect();
        var x = event.clientX - rect.left;
        var y = event.clientY - rect.top;
		//console.log( "x:"+x+",y:"+y);

        // Get the key that was clicked
        var key = getKeyAt(x, y);

        // Call the keyAction function
        keyAction(key, true);
      });
      canvas.addEventListener('mouseup', function(e) {
        // Get the coordinates of the click
		var rect = canvas.getBoundingClientRect();
        var x = event.clientX - rect.left;
        var y = event.clientY - rect.top;
		//console.log( "x:"+x+",y:"+y);

        // Get the key that was clicked
        var key = getKeyAt(x, y);

        // Call the keyAction function
        keyAction(key, false);
      });
      canvas.addEventListener('touchstart', function(e) {
        // Get the coordinates of the touch
        var x = e.touches[0].clientX - canvas.offsetLeft;
        var y = e.touches[0].clientY - canvas.offsetTop;
		//console.log( "x:"+x+",y:"+y);

        // Get the key that was clicked
        var key = getKeyAt(x, y);

        // Call the keyAction function
        keyAction(key, true);
      });

      canvas.addEventListener('touchend', function(e) {
        // Get the coordinates of the touch
        var x = e.changedTouches[0].clientX - canvas.offsetLeft;
        var y = e.changedTouches[0].clientY - canvas.offsetTop;

        // Get the key that was clicked
        var key = getKeyAt(x, y);

        // Call the keyAction function
        keyAction(key, false);
      });
	  
	  
    // Get the key at the specified coordinates
    function getKeyAt(x, y) {
      // Loop through all of the keys
      for (var i = 0; i < keys.length; i++) {
        // If the key is at the specified coordinates, return the key
        if (keys[i].x <= x && x <= keys[i].x + keys[i].width &&
            keys[i].y <= y && y <= keys[i].y + keys[i].height) {
          return keys[i].name;
        }
      }

      // If no key was found, return null
      return null;
    }

 
var keyState = false;
    // Call the keyAction function when a key is clicked or touched
    function keyAction(name, event) {
	 if(name != null){
	 	 console.log('Key ' + name + ' was ' + event);
	  if(event){
	  keyInput.keyDown(name);
	  keyState = false;
	  }else{
	  if( name === "Reset"){ 
	  reset();
	  return;
	  }
	  keyInput.keyUp(name);
	  keyState = false;
	  }
	  }
    }

    var touching = false;
    var lcdDiv = document.getElementById('lcd')
    var wqx = new Wqx(lcdDiv);
    var keyInput = new WqxKeyInput(wqx, document.getElementById('key'));
  
    keyInput.onpress = function (key){
	//keyAction(key,true);
    };
    keyInput.onrelease = function (key){
	//keyAction(key,false);
    };

    var romLoaded = false;
    var norLoaded = false;
    var xhrRom = null;
    function check(){
        if (romLoaded && norLoaded) {
            run();
        }
    }
    lcdDiv.addEventListener('dragover', function (evt){
        evt.preventDefault();
    }, false);
    lcdDiv.addEventListener('drop', function (evt){
        var file;
        try {
            file = evt.dataTransfer.files[0];
        } catch(ex){}
        var fileReader = new FileReader();
        fileReader.addEventListener('loadend', function (evt){
            if (!xhrRom) {
                //xhrRom.abort();
                xhrRom = null;
            }
            wqx.loadBROM(fileReader.result);
            romLoaded = true;
            check();
        }, false);
        fileReader.readAsArrayBuffer(file);
        evt.preventDefault();
    }, false);

    function loadZip(){
        var xhrZip = new XMLHttpRequest();
        xhrZip.addEventListener('progress', function (evt){
            var loadedKB = Math.round(evt.loaded / 1024);
            var totalKB = Math.round(evt.total / 1024);
            document.getElementById('load_demo').innerHTML = 'ROM加载中 ' + loadedKB + 'KB / ' + totalKB + " KB";
        }, false);
        xhrZip.addEventListener('loadend', function (){
            document.getElementById('load_demo').innerHTML = 'ROM加载完毕';
        }, false);
        xhrZip.open('GET', 'rom.zip', true);
        xhrZip.responseType = 'arraybuffer';
        xhrZip.addEventListener('loadend', function (){
            var zipData = xhrZip.response;
            mountBFS(zipData);
        }, false);
        xhrZip.send();
    }

    function mountBFS(zipData) {
        var Buffer = BrowserFS.BFSRequire('buffer').Buffer;
        BrowserFS.configure({
            fs: "ZipFS",
            options: {
                // Wrap as Buffer object.
                zipData: Buffer.from(zipData)
            }
        }, function (e) {
            if (e) {
                // An error occurred.
                throw e;
            }
            var fs = BrowserFS.BFSRequire('fs');
            fs.readFile('/nc1020.fls', function (err, data) {
                wqx.loadNorFlash(data);
                norLoaded = true;
                check();
            });
            fs.readFile('/obj_lu.bin', function (err, data) {
                wqx.loadBROM(data);
                romLoaded = true;
                check();
            });
        });
    }

    function run(){
        wqx.run();
        document.getElementById('run').setAttribute('disabled', 'disabled');
        document.getElementById('stop').removeAttribute('disabled');
    }
    function stop(){
        wqx.stop();
        document.getElementById('stop').setAttribute('disabled', 'disabled');
        document.getElementById('run').removeAttribute('disabled');
    }
    function reset(){
        wqx.reset();
    }
    loadZip();
</script>
</body>
</html>
